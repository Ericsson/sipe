From ddbe866bd982832263ab010aa7392d2b2ef7f176 Mon Sep 17 00:00:00 2001
From: Jakub Adam <jakub.adam@ktknet.cz>
Date: Wed, 24 Nov 2010 22:19:54 +0100
Subject: [PATCH] Allow to set SDES properties of FsRtpConference

---
 libpurple/media.c               |    7 +++++++
 libpurple/media.h               |   20 ++++++++++++++++++++
 libpurple/media/backend-fs2.c   |   34 ++++++++++++++++++++++++++++++++++
 libpurple/media/backend-iface.c |    8 ++++++++
 libpurple/media/backend-iface.h |   12 ++++++++++++
 5 files changed, 81 insertions(+), 0 deletions(-)

diff --git a/libpurple/media.c b/libpurple/media.c
index ca79eed..854adb9 100644
--- a/libpurple/media.c
+++ b/libpurple/media.c
@@ -916,6 +916,13 @@ purple_media_stream_info(PurpleMedia *media, PurpleMediaInfoType type,
 #endif
 }
 
+void purple_media_set_params(PurpleMedia *media, GParameter *params)
+{
+#ifdef USE_VV
+	purple_media_backend_set_params(media->priv->backend, params);
+#endif
+}
+
 #ifdef USE_VV
 static void
 purple_media_new_local_candidate_cb(PurpleMediaBackend *backend,
diff --git a/libpurple/media.h b/libpurple/media.h
index dc84f2d..0017e46 100644
--- a/libpurple/media.h
+++ b/libpurple/media.h
@@ -144,6 +144,26 @@ void purple_media_stream_info(PurpleMedia *media, PurpleMediaInfoType type,
 		gboolean local);
 
 /**
+ * Sets various optional parameters of the media call.
+ *
+ * Currently supported are:
+ *   - "sdes-cname"    : The CNAME for the RTP sessions
+ *   - "sdes-name"     : Real name used to describe the source in SDES messages
+ *   - "sdes-tool"     : The TOOL to put in SDES messages
+ *   - "sdes-email"    : Email address to put in SDES messages
+ *   - "sdes-location" : The LOCATION to put in SDES messages
+ *   - "sdes-note"     : The NOTE to put in SDES messages
+ *   - "sdes-phone"    : The PHONE to put in SDES messages
+ *
+ * @param media The media object to set the parameters on.
+ * @param params Array of @c GParameter to pass to Farsight, terminated with
+ *               NULL-name parameter.
+ *
+ * @since 2.8.0
+ */
+void purple_media_set_params(PurpleMedia *media, GParameter *params);
+
+/**
  * Adds a stream to a session.
  *
  * It only adds a stream to one audio session or video session as
diff --git a/libpurple/media/backend-fs2.c b/libpurple/media/backend-fs2.c
index fd9de82..530da67 100644
--- a/libpurple/media/backend-fs2.c
+++ b/libpurple/media/backend-fs2.c
@@ -85,6 +85,8 @@ static gboolean purple_media_backend_fs2_set_remote_codecs(
 static gboolean purple_media_backend_fs2_set_send_codec(
 		PurpleMediaBackend *self, const gchar *sess_id,
 		PurpleMediaCodec *codec);
+static void purple_media_backend_fs2_set_params(PurpleMediaBackend *self,
+		GParameter *params);
 
 struct _PurpleMediaBackendFs2Class
 {
@@ -367,6 +369,7 @@ purple_media_backend_iface_init(PurpleMediaBackendIface *iface)
 			purple_media_backend_fs2_get_local_candidates;
 	iface->set_remote_codecs = purple_media_backend_fs2_set_remote_codecs;
 	iface->set_send_codec = purple_media_backend_fs2_set_send_codec;
+	iface->set_params = purple_media_backend_fs2_set_params;
 }
 
 static FsMediaType
@@ -1958,6 +1961,37 @@ purple_media_backend_fs2_set_send_codec(PurpleMediaBackend *self,
 
 	return TRUE;
 }
+
+static void purple_media_backend_fs2_set_params(PurpleMediaBackend *self,
+		GParameter *params)
+{
+	PurpleMediaBackendFs2Private *priv;
+
+	g_return_if_fail(PURPLE_IS_MEDIA_BACKEND_FS2(self));
+
+	priv = PURPLE_MEDIA_BACKEND_FS2_GET_PRIVATE(self);
+
+	if (priv->conference == NULL &&
+		!init_conference(PURPLE_MEDIA_BACKEND_FS2(self))) {
+		purple_debug_error("backend-fs2",
+				"Error initializing the conference.\n");
+		return;
+	}
+
+	while (params->name != NULL) {
+		if (!strcmp(params->name, "sdes-cname")    ||
+		    !strcmp(params->name, "sdes-name")     ||
+		    !strcmp(params->name, "sdes-tool")     ||
+		    !strcmp(params->name, "sdes-email")    ||
+		    !strcmp(params->name, "sdes-location") ||
+		    !strcmp(params->name, "sdes-note")     ||
+		    !strcmp(params->name, "sdes-phone"))
+			g_object_set(priv->conference,
+				     params->name, g_value_get_string(&params->value),
+				     NULL);
+		params += 1;
+	}
+}
 #else
 GType
 purple_media_backend_fs2_get_type(void)
diff --git a/libpurple/media/backend-iface.c b/libpurple/media/backend-iface.c
index 9c06934..fef2f2f 100644
--- a/libpurple/media/backend-iface.c
+++ b/libpurple/media/backend-iface.c
@@ -192,3 +192,11 @@ purple_media_backend_set_send_codec(PurpleMediaBackend *self,
 	return PURPLE_MEDIA_BACKEND_GET_INTERFACE(self)->set_send_codec(self,
 			sess_id, codec);
 }
+
+void
+purple_media_backend_set_params(PurpleMediaBackend *self,
+		GParameter *params)
+{
+	g_return_if_fail(PURPLE_IS_MEDIA_BACKEND(self));
+	PURPLE_MEDIA_BACKEND_GET_INTERFACE(self)->set_params(self, params);
+}
diff --git a/libpurple/media/backend-iface.h b/libpurple/media/backend-iface.h
index 258db85..f1edfaf 100644
--- a/libpurple/media/backend-iface.h
+++ b/libpurple/media/backend-iface.h
@@ -68,6 +68,7 @@ struct _PurpleMediaBackendIface
 		GList *codecs);
 	gboolean (*set_send_codec) (PurpleMediaBackend *self,
 		const gchar *sess_id, PurpleMediaCodec *codec);
+	void (*set_params) (PurpleMediaBackend *self, GParameter *params);
 };
 
 /**
@@ -191,6 +192,17 @@ gboolean purple_media_backend_set_remote_codecs(PurpleMediaBackend *self,
 gboolean purple_media_backend_set_send_codec(PurpleMediaBackend *self,
 		const gchar *sess_id, PurpleMediaCodec *codec);
 
+/**
+ * Sets various optional parameters of the media backend.
+ *
+ * @param self The media backend to set the parameters on.
+ * @param params Array of @c GParameter to pass to backend, terminated with
+ *               NULL-name parameter.
+ *
+ * @since 2.8.0
+ */
+void purple_media_backend_set_params(PurpleMediaBackend *self, GParameter *params);
+
 G_END_DECLS
 
 #endif /* _MEDIA_BACKEND_IFACE_H_ */
-- 
1.7.2.3

